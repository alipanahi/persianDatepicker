/*
 * 
 * persian-datepicker -  1.0.1
 * Ali Hussain Panahi <p.alihussain@gmail.com>
 * 
 * 
 */
const miladi_month_days=[31,28,31,30,31,30,31,31,30,31,30,31],shamsi_month_days=[31,31,31,31,31,31,30,30,30,30,30,29],shamsi_months=["حمل","ثور","جوزا","سرطان","اسد","سنبله","میزان","عقرب","قوس","جدی","دلو","حوت"],miladi_months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];let body=document.getElementsByTagName("body")[0],section=document.createElement("section");section.setAttribute("id","container"),body.appendChild(section);let sectionContent='\n<header>\n    <button class="today" id="todayBtn">امروز</button>\n    <h1><span id="shamsiDate"></span></h1>\n    <div class="week-days" dir="rtl">\n        <p>ش</p>\n        <p>ی</p>\n        <p>د</p>\n        <p>س</p>\n        <p>چ</p>\n        <p>پ</p>\n        <p>ج</p>\n    </div>\n    <div id="days" dir="rtl"></div>\n</header>\n<div class="actions">\n    <button id="nextMonth" aria-label="Previous"><</button>\n    <button id="previousMonth" aria-label="Next">></button>\n</div>\n<div id="modal" style="display:none">\n    <select id="select_year"></select>\n    <select id="select_month"></select>\n    <button id="modalBtn" class="modalBtn">انتخاب</button>\n</div>\n';section.innerHTML=sectionContent,section.style.display="none";let container=document.getElementById("container");const modal=document.getElementById("modal"),shamsiDateSpan=document.getElementById("shamsiDate"),daysDiv=document.getElementById("days"),nextBtn=document.getElementById("nextMonth"),previousBtn=document.getElementById("previousMonth"),modalOpen=document.getElementById("modalBtn"),todayBtn=document.getElementById("todayBtn");let selectedMonth=0,selectedYear=0,currentSYear=0,currentSMonth=0,currentSDay=0,isCurrentMoth=!0,paired=[],settings={format:"yyyy/mm/dd",autoClose:!0,dateSeperator:"/"};function renderToday(){clearOldData();let e=Date.now(),t=new Date(e).toLocaleDateString().split("/"),n=t[0],d=t[1],a=dateToShamsi(t[2],n,d);selectedYear=a[0],selectedMonth=a[1],renderCalendar(a[0],a[1],a[2])}function renderCalendar(e,t,n){t!=currentSMonth&&0!=t||(isCurrentMoth=!0),shamsiDateSpan.textContent=e+" "+shamsi_months[t-1];let d=dateToMiladi(e,t,1),a=shamsi_month_days[t-1];12==t&&shamsiIsLeap(e)&&(a=30);let l=dateToMiladi(e,t,a);pairShamsiWithMiladi(d[0],d[1],d[2],l[2]);let s=new Date(d[0],d[1]-1,d[2]).getDay(),o=new Date(l[0],l[1]-1,l[2]).getDay();if(6!=s)for(let e=0;e<=s;e++){let e=document.createElement("span");e.classList.add("day"),daysDiv.appendChild(e)}for(let e=1;e<=a;e++){let t=document.createElement("div");t.setAttribute("id","day_"+e),t.setAttribute("onclick","putDate("+e+")"),t.classList.add("day"),e==currentSDay&&isCurrentMoth&&t.classList.add("current-day"),daysDiv.appendChild(t);let n=document.createElement("span");n.classList.add("shamsi_day"),n.textContent=e,document.getElementById("day_"+e).appendChild(n)}if(6!=o)for(let e=o;e<5;e++){let e=document.createElement("span");e.classList.add("day"),daysDiv.appendChild(e)}else{let e=document.createElement("span");e.classList.add("day"),daysDiv.appendChild(e)}}function dateToShamsi(e,t,n){let d=e-1600,a=t-1,l=n-1,s=365*d+div(d+3,4)-div(d+99,100)+div(d+399,400);for(let e=0;e<a;++e)s+=miladi_month_days[e];a>1&&(d%4==0&&d%100!=0||d%400==0)&&++s;let o=(s+=l)-79,i=979+33*div(o,12053)+4*div(o%=12053,1461);(o%=1461)>=366&&(i+=div(o-1,365),o=(o-1)%365);let r=0;for(let e=0;e<11&&o>=shamsi_month_days[e];++e)o-=shamsi_month_days[e],r=e+1;let c=r+1;selectedMonth=c,selectedYear=i,currentSMonth=c,currentSYear=i;let m=o+1;return currentSDay=m,[i,c,m]}function dateToMiladi(e,t,n){let d=e-979,a=t-1,l=n-1,s=365*d+8*div(d,33)+div(d%33+3,4);for(let e=0;e<a;++e)s+=shamsi_month_days[e];let o=(s+=l)+79,i=1600+400*div(o,146097),r=1;(o%=146097)>=36525&&(i+=100*div(o-=1,36524),(o%=36524)>=365?o+=1:r=0),i+=4*div(o,1461),(o%=1461)>=366&&(r=0,i+=div(o-=1,365),o%=365);let c=0,m=0;for(;o>=miladi_month_days[c]+m;)m=1==c&&1==r?1:0,o-=miladi_month_days[c]+m,c+=1;return[i,c+1,o+1]}function loadNextMonth(){clearOldData(),12==selectedMonth?(selectedMonth=1,selectedYear+=1):selectedMonth+=1,renderCalendar(selectedYear,selectedMonth,1)}function loadPreviousMonth(){clearOldData(),1==selectedMonth?(selectedMonth=12,selectedYear-=1):selectedMonth-=1,renderCalendar(selectedYear,selectedMonth,1)}function pairShamsiWithMiladi(e,t,n,d){let a=miladi_month_days[t-1];for(2==t&&miladiIsLeap(e)&&(a=29),paired=[];n<=a;)paired.push(n),n++;paired.push(miladi_months[t]);for(let e=2;e<=d;e++)paired.push(e)}function LoadModal(){for(let e=currentSYear-50;e<=currentSYear+10;e++){let t=document.createElement("option");t.setAttribute("value",e),e==selectedYear&&t.setAttribute("selected","selected"),t.textContent=e,document.getElementById("select_year").appendChild(t)}for(let e=0;e<shamsi_months.length;e++){let t=document.createElement("option");t.setAttribute("value",e+1),e+1==selectedMonth&&t.setAttribute("selected","selected"),t.textContent=shamsi_months[e],document.getElementById("select_month").appendChild(t)}modal.style.display="block"}function renderModal(){let e=document.getElementById("select_year").value,t=document.getElementById("select_month").value;clearOldData(),selectedYear=parseInt(e),selectedMonth=parseInt(t),modal.style.display="none",renderCalendar(e,t,1)}function loadDatepicker(e){if(""==e.value)renderToday();else{clearOldData();let t="/";settings.dateSeperator&&(t=settings.dateSeperator);let n,d,a,l=e.value.split(t);if(settings.format){let e=settings.format.split("/");"yyyy"===e[0]&&"mm"===e[1]&&"dd"===e[2]?(n=l[0],d=l[1],a=l[2]):"yyyy"===e[0]&&"dd"===e[1]&&"mm"===e[2]?(n=l[0],d=l[2],a=l[1]):"dd"===e[0]&&"mm"===e[1]&&"yyyy"===e[2]?(n=l[2],d=l[1],a=l[0]):"dd"===e[0]&&"yyyy"===e[1]&&"mm"===e[2]?(n=l[1],d=l[2],a=l[0]):"mm"===e[0]&&"dd"===e[1]&&"yyyy"===e[2]?(n=l[2],d=l[0],a=l[1]):"mm"===e[0]&&"yyyy"===e[1]&&"dd"===e[2]&&(n=l[1],d=l[0],a=l[2])}else n=l[0],d=l[1],a=l[2];renderCalendar(n,d,a)}textBox=e;let t=e.getBoundingClientRect().top,n=e.getBoundingClientRect().height,d=e.getBoundingClientRect().left;container.style.left=d+"px",container.style.top=t+n+"px",container.style.display="block",document.addEventListener("mouseup",function(e){container.contains(e.target)||(document.getElementById("modal").style.display="none",container.style.display="none")})}function putDate(e){let t="/";if(settings.dateSeperator&&(t=settings.dateSeperator),settings.format){let n=settings.format.split("/");"yyyy"===n[0]&&"mm"===n[1]&&"dd"===n[2]?textBox.value=selectedYear+t+selectedMonth+t+e:"yyyy"===n[0]&&"dd"===n[1]&&"mm"===n[2]?textBox.value=selectedYear+t+e+t+selectedMonth:"dd"===n[0]&&"mm"===n[1]&&"yyyy"===n[2]?textBox.value=e+t+selectedMonth+t+selectedYear:"dd"===n[0]&&"yyyy"===n[1]&&"mm"===n[2]?textBox.value=e+t+selectedYear+t+selectedMonth:"mm"===n[0]&&"dd"===n[1]&&"yyyy"===n[2]?textBox.value=selectedMonth+t+e+sseperator+selectedYear:"mm"===n[0]&&"yyyy"===n[1]&&"dd"===n[2]&&(textBox.value=selectedMonth+t+selectedYear+t+e)}else textBox.value=selectedYear+t+selectedMonth+t+e;!1===settings.autoClose?container.style.display="block":container.style.display="none"}function div(e,t){return Math.floor(e/t)}function clearOldData(){shamsiDateSpan.innerHTML="",daysDiv.innerHTML="",isCurrentMoth=!1}function miladiIsLeap(e){return e%4==0&&(e%100!=0||e%400==0)}function shamsiIsLeap(e){return(e=(e=((e=(e-474)%128)>=30?0:29)+e)-Math.floor(e/33)-1)%4==0}nextBtn.addEventListener("click",loadNextMonth),previousBtn.addEventListener("click",loadPreviousMonth),shamsiDateSpan.addEventListener("click",LoadModal),modalOpen.addEventListener("click",renderModal),todayBtn.addEventListener("click",renderToday),window.onclick=function(e){e.target==modal&&(modal.style.display="none")},window.addEventListener("mouseup",function(e){"datepicker-farsi"==e.target.classList&&e.target.addEventListener("click",loadDatepicker(e.target))});